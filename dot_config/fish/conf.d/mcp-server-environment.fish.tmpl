# =============================================================================
# MCP Server Environment Variables
# =============================================================================
# Environment variables for Model Context Protocol (MCP) servers
# Used by Amazon Q CLI, VS Code, and other MCP-compatible tools
# Managed by chezmoi with Bitwarden integration

# Alertmanager MCP Server
# ----------------------
set -gx ALERTMANAGER_URL "https://alertmanager.rafaribe.com"

# OPNsense MCP Server
# ------------------
{{- if (bitwarden "item" "OPNsense") }}
{{- $opnsense := (bitwarden "item" "OPNsense") }}
{{- $opnsenseUrl := "https://10.0.0.1" }}
{{- if $opnsense.login.uris }}
{{- $opnsenseUrl = (index $opnsense.login.uris 0).uri }}
{{- end }}
set -gx OPNSENSE_URL "{{ $opnsenseUrl }}"
{{- range $opnsense.fields }}
{{- if eq .name "api_key" }}
set -gx OPNSENSE_API_KEY "{{ .value }}"
{{- end }}
{{- if eq .name "api_secret" }}
set -gx OPNSENSE_API_SECRET "{{ .value }}"
{{- end }}
{{- end }}
{{- else }}
# OPNsense credentials not found in Bitwarden - using placeholders
set -gx OPNSENSE_URL "http://10.0.0.1"
set -gx OPNSENSE_API_KEY "your-api-key-here"
set -gx OPNSENSE_API_SECRET "your-api-secret-here"
{{- end }}
set -gx OPNSENSE_VERIFY_SSL "false"  # Set to "true" if using valid SSL cert
set -gx INCLUDE_PLUGINS "true"  # Include OPNsense plugins in API responses

# FluxCD MCP Server
# ----------------
set -gx KUBECONFIG "$HOME/.kube/config"

# GitHub MCP Server
# ----------------
{{- if (bitwarden "item" "github") }}
{{- $github := (bitwarden "item" "github") }}
{{- range $github.fields }}
{{- if eq .name "GITHUB_TOKEN" }}
set -gx GITHUB_PERSONAL_ACCESS_TOKEN "{{ .value }}"
{{- end }}
{{- end }}
{{- else }}
# GitHub token not found in Bitwarden - commenting out
# set -gx GITHUB_PERSONAL_ACCESS_TOKEN "your-github-token-here"
{{- end }}

# PostgreSQL MCP Server
# ---------------------
{{- if (bitwarden "item" "PostgreSQL MCP") }}
{{- $postgres := (bitwarden "item" "PostgreSQL MCP") }}
{{- $host := "localhost" }}
{{- $port := "5432" }}
{{- $database := "" }}
{{- range $postgres.fields }}
{{- if eq .name "host" }}{{- $host = .value }}{{- end }}
{{- if eq .name "port" }}{{- $port = .value }}{{- end }}
{{- if eq .name "database" }}{{- $database = .value }}{{- end }}
{{- end }}
set -gx POSTGRES_CONNECTION_STRING "postgresql://{{ $postgres.login.username }}:{{ $postgres.login.password }}@{{ $host }}:{{ $port }}/{{ $database }}"
{{- else }}
# PostgreSQL credentials not found in Bitwarden - using individual parameters if available
{{- if (bitwarden "item" "PostgreSQL") }}
{{- $pg := (bitwarden "item" "PostgreSQL") }}
{{- $host := "localhost" }}
{{- $port := "5432" }}
{{- $database := "" }}
{{- $username := "" }}
{{- $password := "" }}
{{- range $pg.fields }}
{{- if eq .name "host" }}{{- $host = .value }}{{- end }}
{{- if eq .name "port" }}{{- $port = .value }}{{- end }}
{{- if eq .name "database" }}{{- $database = .value }}{{- end }}
{{- if eq .name "username" }}{{- $username = .value }}{{- end }}
{{- if eq .name "password" }}{{- $password = .value }}{{- end }}
{{- end }}
set -gx POSTGRES_HOST "{{ $host }}"
set -gx POSTGRES_PORT "{{ $port }}"
set -gx POSTGRES_USER "{{ $username }}"
set -gx POSTGRES_PASSWORD "{{ $password }}"
set -gx POSTGRES_DATABASE "{{ $database }}"
{{- else }}
# PostgreSQL not configured - commenting out
# set -gx POSTGRES_CONNECTION_STRING "postgresql://username:password@localhost:5432/database"
{{- end }}
{{- end }}

# =============================================================================
# Bitwarden Item Structure Expected:
# =============================================================================
# 
# OPNsense:
#   - Type: Login
#   - URI: https://your-opnsense-url
#   - Custom Fields:
#     - api_key (text)
#     - api_secret (text)
#
# github:
#   - Type: Login or Secure Note
#   - Custom Fields:
#     - GITHUB_TOKEN (secret)
#
# PostgreSQL MCP (optional):
#   - Type: Login
#   - Username: db_username
#   - Password: db_password
#   - Custom Fields:
#     - host (text)
#     - port (text)
#     - database (text)
# =============================================================================
